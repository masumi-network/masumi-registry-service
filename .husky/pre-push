#!/usr/bin/env sh

# Portable and safe way to handle colors
if command -v tput >/dev/null 2>&1 && [ -t 1 ]; then
    # We have tput and it's an interactive terminal
    if tput setaf 1 >/dev/null 2>&1; then
        GREEN=$(tput setaf 2)
        RED=$(tput setaf 1)
        BLUE=$(tput setaf 4)
        YELLOW=$(tput setaf 3)
        NC=$(tput sgr0)
    else
        GREEN=""
        RED=""
        BLUE=""
        YELLOW=""
        NC=""
    fi
else
    GREEN=""
    RED=""
    BLUE=""
    YELLOW=""
    NC=""
fi

# Check if we're in a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "${RED}âŒ Not a git repository${NC}"
    exit 1
fi

# Check if npm is available
if ! command -v npm >/dev/null 2>&1; then
    echo "${RED}âŒ npm is not installed or not in PATH${NC}"
    exit 2
fi

# Protected branches
protected_branches="^(main|dev)$"

# Get the current branch in a cross-platform way
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || git rev-parse --short HEAD)

# Read standard input in a while loop
while IFS= read -r line || [ -n "$line" ]; do
    if [ -z "$line" ]; then
        continue
    fi
    
    # Split the line into components safely
    local_ref=$(echo "$line" | cut -d' ' -f1)
    local_sha=$(echo "$line" | cut -d' ' -f2)
    remote_ref=$(echo "$line" | cut -d' ' -f3)
    remote_sha=$(echo "$line" | cut -d' ' -f4)
    
    # Extract branch name from ref
    remote_branch=${remote_ref##*/}
    
    if echo "$remote_branch" | grep -qE "$protected_branches"; then
        echo "${RED}âŒ Direct push to $remote_branch branch is not allowed${NC}"
        echo "${YELLOW}Please create a pull request instead.${NC}"
        exit 3
    fi
done

# Run ESLint only on staged files
echo "${BLUE}ğŸ” Running ESLint on staged files...${NC}"
if command -v git-rev-parse >/dev/null 2>&1 && [ -d .git ]; then
    staged_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.ts' '*.js' '*.tsx' '*.jsx' 2>/dev/null)
    if [ -n "$staged_files" ]; then
        echo "$staged_files" | tr '\n' '\0' | xargs -0 npm run lint -- || 
        (
            echo "${RED}âŒ ESLint check failed. Please fix the errors and try committing again.${NC}"
            exit 4
        )
    fi
fi

# Run ESLint only on staged files
echo "${BLUE}ğŸ” Running format on staged files...${NC}"
if command -v git-rev-parse >/dev/null 2>&1 && [ -d .git ]; then
    staged_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.ts' '*.js' '*.tsx' '*.jsx' 2>/dev/null)
    if [ -n "$staged_files" ]; then
        echo "$staged_files" | tr '\n' '\0' | xargs -0 npm run format -- || 
        (
            echo "${RED}âŒ Formatting failed. Please fix the errors and try committing again.${NC}"
            exit 4
        )
    fi
fi

# Generate Swagger documentation
echo "${BLUE}ğŸ” Generating Swagger documentation...${NC}"
if ! npm run swagger-json; then
    echo "${RED}âŒ Swagger documentation generation failed. Please fix any API documentation issues and try again.${NC}"
    exit 6
fi


# Check for changes in generated files
echo "${BLUE}ğŸ” Checking for generated file changes...${NC}"
if git diff --quiet; then
    echo "${GREEN}âœ… No changes in generated files${NC}"
else
    echo "${BLUE}ğŸ“ Committing generated file changes...${NC}"
    git add .
    git commit -m "chore: update generated files" --no-verify
    echo "${GREEN}âœ… Generated files committed${NC}"
fi

echo "${GREEN}âœ… All pre-push checks completed!${NC}" 